<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Studio History Cleaner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS (Inline SVGs to avoid complex CDN imports) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            FileJson: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Copy: (props) => <Icon {...props} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />
        };

        // --- COMPONENTS ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-blue-600 hover:bg-blue-700 text-white shadow-md hover:shadow-lg transform active:scale-95",
                secondary: "bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 shadow-sm",
                danger: "bg-red-50 hover:bg-red-100 text-red-600 border border-red-200",
                ghost: "hover:bg-slate-100 text-slate-600"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} disabled={disabled}>
                    {children}
                </button>
            );
        };

        // --- MAIN APP LOGIC ---

        function App() {
            const [files, setFiles] = useState([]);
            const [output, setOutput] = useState("");
            const [includeThoughts, setIncludeThoughts] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [dragActive, setDragActive] = useState(false);

            const parseAIStudioJSON = (json) => {
                try {
                    const data = JSON.parse(json);
                    let conversation = [];
                    
                    // Handle standard AI Studio export format
                    const chunks = data.chunkedPrompt?.chunks || data.chunks || [];

                    chunks.forEach((chunk) => {
                        const role = chunk.role === 'model' ? 'Model' : 'User';
                        let content = '';
                        let thoughts = [];

                        // Strategy 1: Top level text
                        if (chunk.text) {
                            content = chunk.text;
                        }

                        // Strategy 2: Parts array (common in AI Studio exports)
                        if (chunk.parts && Array.isArray(chunk.parts)) {
                            chunk.parts.forEach(part => {
                                if (part.thought || part.isThought) {
                                    thoughts.push(part.text);
                                } else if (part.text) {
                                    content += part.text;
                                }
                            });
                        }

                        if (content.trim() || thoughts.length > 0) {
                            conversation.push({
                                role,
                                content: content.trim(),
                                thoughts: thoughts.join('\n\n'),
                                hasThoughts: thoughts.length > 0
                            });
                        }
                    });

                    return conversation;
                } catch (e) {
                    console.error("Parse Error", e);
                    return null;
                }
            };

            const handleFiles = async (fileList) => {
                setIsProcessing(true);
                const newFiles = Array.from(fileList);
                let combinedMarkdown = "";

                for (const file of newFiles) {
                    const text = await file.text();
                    const conversation = parseAIStudioJSON(text);
                    
                    if (conversation) {
                        combinedMarkdown += `# Source: ${file.name}\n\n`;
                        
                        conversation.forEach(msg => {
                            const roleIcon = msg.role === 'User' ? 'ðŸ‘¤' : 'ðŸ¤–';
                            
                            if (includeThoughts && msg.hasThoughts) {
                                combinedMarkdown += `> **ðŸ§  Thinking Process**\n> \n`;
                                const indentedThoughts = msg.thoughts.split('\n').map(line => `> ${line}`).join('\n');
                                combinedMarkdown += `${indentedThoughts}\n\n`;
                            }

                            combinedMarkdown += `## ${roleIcon} ${msg.role}\n\n`;
                            combinedMarkdown += `${msg.content}\n\n`;
                            combinedMarkdown += `---\n\n`;
                        });
                    } else {
                        combinedMarkdown += `> âš ï¸ Error parsing file: ${file.name}\n\n`;
                    }
                }

                setOutput(combinedMarkdown);
                setFiles(newFiles);
                setIsProcessing(false);
            };

            const onDragEnter = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(true); };
            const onDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(false); };
            const onDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
            const onDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFiles(e.dataTransfer.files);
                }
            };

            const handleInputChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFiles(e.target.files);
                }
            };

            const copyToClipboard = () => {
                const el = document.createElement('textarea');
                el.value = output;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
            };

            const downloadMarkdown = () => {
                const element = document.createElement("a");
                const file = new Blob([output], {type: 'text/markdown'});
                element.href = URL.createObjectURL(file);
                element.download = "cleaned_chat_history.md";
                document.body.appendChild(element);
                element.click();
            };

            useEffect(() => {
                if (files.length > 0) {
                    handleFiles(files);
                }
            }, [includeThoughts]);

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 p-6 md:p-12">
                    <div className="max-w-6xl mx-auto space-y-8">
                        
                        {/* Header */}
                        <div className="text-center space-y-2">
                            <h1 className="text-4xl font-bold tracking-tight text-slate-900">
                                AI Studio <span className="text-blue-600">Cleaner</span>
                            </h1>
                            <p className="text-slate-500 max-w-2xl mx-auto">
                                Drag and drop your Google AI Studio export JSON files to extract a clean, readable Markdown chat history.
                            </p>
                        </div>

                        {/* Main Grid */}
                        <div className="grid md:grid-cols-3 gap-6 h-[70vh]">
                            
                            {/* Left Column */}
                            <div className="md:col-span-1 flex flex-col gap-6 h-full">
                                
                                {/* Upload Zone */}
                                <div 
                                    className={`flex-1 rounded-xl border-2 border-dashed transition-all duration-200 flex flex-col items-center justify-center p-8 text-center cursor-pointer relative bg-white
                                        ${dragActive ? 'border-blue-500 bg-blue-50' : 'border-slate-300 hover:border-blue-400 hover:bg-slate-50'}`}
                                    onDragEnter={onDragEnter}
                                    onDragLeave={onDragLeave}
                                    onDragOver={onDragOver}
                                    onDrop={onDrop}
                                >
                                    <input 
                                        type="file" 
                                        multiple 
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                        onChange={handleInputChange}
                                        accept=".json,.txt"
                                    />
                                    <div className="bg-blue-100 p-4 rounded-full mb-4">
                                        <Icons.FileJson className="w-8 h-8 text-blue-600" />
                                    </div>
                                    <h3 className="font-semibold text-lg text-slate-700 mb-1">Upload JSON</h3>
                                    <p className="text-sm text-slate-500">Drag & drop or click to browse</p>
                                </div>

                                {/* Controls */}
                                <Card className="p-5 space-y-4">
                                    <div className="flex items-center justify-between">
                                        <span className="font-medium text-slate-700 flex items-center gap-2">
                                            <span className="text-lg">ðŸ§ </span> Thoughts
                                        </span>
                                        <button 
                                            onClick={() => setIncludeThoughts(!includeThoughts)}
                                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${includeThoughts ? 'bg-blue-600' : 'bg-slate-200'}`}
                                        >
                                            <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${includeThoughts ? 'translate-x-6' : 'translate-x-1'}`} />
                                        </button>
                                    </div>
                                    <p className="text-xs text-slate-500">
                                        Enable to include "Reasoning" blocks in output.
                                    </p>
                                    <div className="pt-2 border-t border-slate-100">
                                        <div className="flex flex-col gap-2">
                                            {files.length > 0 && (
                                                <div className="text-sm text-slate-600 font-medium mb-2">
                                                    Processing {files.length} file(s)
                                                </div>
                                            )}
                                            <Button onClick={() => {setFiles([]); setOutput("");}} variant="danger" disabled={!output} className="w-full justify-center">
                                                <Icons.Trash2 className="w-4 h-4" /> Clear All
                                            </Button>
                                        </div>
                                    </div>
                                </Card>

                            </div>

                            {/* Right Column */}
                            <div className="md:col-span-2 flex flex-col h-full">
                                <Card className="flex-1 flex flex-col h-full shadow-md">
                                    <div className="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                        <h2 className="font-semibold text-slate-700 flex items-center gap-2">
                                            <Icons.FileText className="w-4 h-4 text-blue-500" /> Preview
                                        </h2>
                                        <div className="flex gap-2">
                                            <Button variant="secondary" onClick={copyToClipboard} disabled={!output} className="text-sm py-1.5 h-9">
                                                <Icons.Copy className="w-4 h-4" /> Copy
                                            </Button>
                                            <Button onClick={downloadMarkdown} disabled={!output} className="text-sm py-1.5 h-9">
                                                <Icons.Download className="w-4 h-4" /> Download .md
                                            </Button>
                                        </div>
                                    </div>

                                    <div className="flex-1 relative bg-white">
                                        {output ? (
                                            <textarea 
                                                className="w-full h-full p-6 resize-none focus:outline-none font-mono text-sm text-slate-800 leading-relaxed"
                                                value={output}
                                                readOnly
                                            />
                                        ) : (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                                                <div className="bg-slate-50 p-4 rounded-full mb-3">
                                                    <Icons.RefreshCw className={`w-6 h-6 ${isProcessing ? 'animate-spin text-blue-500' : ''}`} />
                                                </div>
                                                <p>Upload a file to generate Markdown</p>
                                            </div>
                                        )}
                                    </div>
                                </Card>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>